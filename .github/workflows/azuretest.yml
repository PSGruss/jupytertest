# This is a basic workflow to help you get started with Actions

name: CreateContainerInAzure

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ AzureTest ]
  pull_request:
    branches: [ AzureTest ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
    
    - name: Login to Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIAL }}
    
    - name: Build and Push Image to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LoginServer }}
        username: ${{ secrets.ACR_UserName }}
        password: ${{ secrets.ACR_Password }}
    - run: |
        docker build ./flasktest -t jgcontainertest.azurecr.io/jgflasktest:${{ github.sha }}
        docker tag jgcontainertest.azurecr.io/jgflasktest:${{ github.sha }} jgcontainertest.azurecr.io/jgflasktest
        docker push jgcontainertest.azurecr.io/jgflasktest
        
    - name: Deploy Container to Azure Container Instance
      uses: azure/aci-deploy@v1
      with:
        resource-group: VDS-JGContainerTest
        dns-name-label: jgtest
        image: jgcontainertest.azurecr.io/jgflasktest:latest
        registry-login-server: ${{ secrets.ACR_LoginServer }}
        registry-username: ${{ secrets.ACR_UserName }}
        registry-password: ${{ secrets.ACR_Password }}
        name: jgcontainertest
        location: 'east us'
        secure-environment-variables: SECRET_PASSWORD=${{ secrets.SECRET_PASSWORD }}
        
    - name: Slack Notify
      uses: rtCamp/action-slack-notify@v2.0.2
      env:
        SLACK_CHANNEL: github-actions
        SLACK_COLOR: '#3278BD'
        SLACK_ICON: https://cdn2.iconfinder.com/data/icons/font-awesome/1792/github-square-512.png
        SLACK_TITLE: Jupytertest Image
        SLACK_MESSAGE: "Jupyter Test has built a new image. go to https://hub.docker.com/repository/docker/jgruss/jupytertest or pull jgruss/jupytertest:latest"
        SLACK_USERNAME: github-actions-bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}     
